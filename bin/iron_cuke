#!/usr/bin/env ruby
$: << File.dirname(__FILE__)+'/../lib'
require 'iron_cuke'

# configliere
Settings.use :commandline
Settings.use :commands

Settings.define_command :test,      :description => "Execute entire test flow"
Settings.define_command :learn,     :description => "Retrieve node announcements from the Chef server"
Settings.define_command :gen_tests, :description => "Generate cucumber tests"
Settings.define_command :judge,     :description => "Execute cucumber tests on the VM"

Settings({
  knife_config: "#{Dir.pwd}/knife/knife.rb",
  node: '*',
  test_dir: File.dirname(__FILE__)+'/../features',
  announces_file: File.dirname(__FILE__)+'/../announces.json',
  retrieve_announces: false,
})

#test
Settings.define :retrieve_announces, flag: 'r', description: 'Ironcuke will retrieve announcements from the Chef server', type: :boolean
#learn
Settings.define :knife_config, flag: 'k', description: 'Location of knife config'
Settings.define :node, flag: 'n', description: 'Description of chef node(s) to test'
#gen_tests
Settings.define :test_dir, flag: 't', description: 'Directory to store the generated cucumber features'
Settings.define :announces_file, flag: 'a', description: 'File containing JSON announcements'

Settings.resolve!

#get absolute paths
Settings[:announces_file] = File.expand_path(Settings[:announces_file])
Settings[:test_dir] = File.expand_path(Settings[:test_dir])
Settings[:knife_config] = File.expand_path(Settings[:knife_config])

def retrieve_announces
  puts "Retrieving announcements from the chef server and depositing them in '#{Settings[:announces_file]}'..."
  Chef::Config.from_file(Settings[:knife_config])
  query = Chef::Search::Query.new
  nodes = {}
  query.search(:node,"name:#{Settings[:node]}") do |node|
    nodes[node.name] = node['announces'].to_hash unless node['announces'].nil?
  end
  File.open(Settings[:announces_file], 'w') {|f| f.write(nodes.to_json)}
end

def gen_tests
  puts "Generating tests from announcements at '#{Settings[:announces_file]}' and depositing them in '#{Settings[:test_dir]}'..."
  announces = File.open(Settings[:announces_file],'r')
  servers = JSON.parse(announces.read)
  servers.keys.each do |server_name|
    model = ModelFactory.generate_model(server_name,servers[server_name])
    Proctor.write_tests(model,Settings[:test_dir])
  end
end

def judge
  puts "Unleashing storms of judgement..."
  cuke_dir = Pathname.new(Settings[:test_dir]).parent
  Dir.chdir(cuke_dir.to_s)
  tests_passed = system 'bundle exec cucumber'
  if tests_passed.nil? or not tests_passed
    puts "Error running tests..."
    exit 1
  end
end

case Settings.command_name
when :test
  retrieve_announces if Settings[:retrieve_announces] or not File.exists?(Settings[:announces_file])
  gen_tests; judge;
when :learn
  retrieve_announces
when :gen_tests
  gen_tests
when :judge
  judge
else
  Settings.die "Please use one of the given commands"
end
