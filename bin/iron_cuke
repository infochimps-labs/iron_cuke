#!/usr/bin/env ruby
$: << File.dirname(__FILE__)+'/../lib'
require 'iron_cuke'

# configliere
Settings.use :commandline
Settings({
  knife_config: [Dir.pwd,'knife','knife.rb'].join('/'),
  node: '*',
  output_dir: File.dirname(__FILE__)+'/../features'
})
Settings.define :knife_config, flag: 'k', description: 'Directory of the Chef homebase'
Settings.define :output_dir, flag: 'o', description: 'Directory to store the generated cucumber features'
Settings.define :node, description: 'Description of chef node(s) to test'
Settings.resolve!

if Settings.rest.length == 1
  Settings[:node] = Settings.rest[0]
end

nodes = []
Chef::Config.from_file(Settings[:knife_config])
query = Chef::Search::Query.new
query.search(:node,"name:#{Settings[:node]}") do |node|
  nodes << ModelFactory.generate_model(node)
end

nodes.each do |node|
  TestWriter.render(node,Settings[:output_dir])
end


